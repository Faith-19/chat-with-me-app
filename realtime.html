<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>QuickChat | Tumelo Mokoena </title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style id="app-style">
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      height: 100vh;
      overflow: hidden;
    }

    .chat-container {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      scroll-behavior: smooth;
    }

    .message-bubble {
      max-width: 75%;
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
      border-radius: 1rem;
      position: relative;
    }

    .sent {
      background-color: #dcf8c6;
      border-top-right-radius: 0;
      margin-left: auto;
    }

    .received {
      background-color: #f1f0f0;
      border-top-left-radius: 0;
      margin-right: auto;
    }

    .timestamp {
      font-size: 0.7rem;
      margin-top: 0.25rem;
      opacity: 0.7;
    }

    .typing-indicator {
      display: flex;
      padding: 0.5rem 1rem;
      border-radius: 1rem;
      background-color: #f1f0f0;
      width: max-content;
      margin-bottom: 0.5rem;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #777;
      margin: 0 2px;
      animation: typing-animation 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) {
      animation-delay: 0s;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing-animation {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-5px);
      }
    }

    .contact-item {
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .contact-item:hover {
      background-color: #f0f0f0;
    }

    .contact-item.active {
      background-color: #e5e7eb;
    }

    .message-input {
      resize: none;
      max-height: 120px;
      min-height: 40px;
    }

    .file-preview {
      max-width: 200px;
      max-height: 150px;
      object-fit: contain;
      border-radius: 0.5rem;
    }

    .image-attachment {
      max-width: 200px;
      max-height: 200px;
      border-radius: 0.5rem;
      cursor: pointer;
    }

    .file-attachment {
      display: flex;
      align-items: center;
      padding: 0.5rem;
      background-color: #f5f5f5;
      border-radius: 0.5rem;
      margin-top: 0.5rem;
    }

    .read-receipt {
      font-size: 0.7rem;
      text-align: right;
      margin-top: 2px;
      color: #6b7280;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }

    .hidden {
      display: none;
    }

    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: -100%;
        top: 0;
        bottom: 0;
        transition: left 0.3s ease;
        z-index: 50;
      }

      .sidebar.open {
        left: 0;
      }

      .sidebar-overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 40;
      }
    }
  </style>
</head>
<body class="bg-gray-100">
  <!-- Username Modal -->
  <div id="username-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
      <h2 class="text-xl font-bold mb-4">Welcome to QuickChat</h2>
      <p class="mb-4">Please enter a username to continue:</p>
      <form id="username-form" class="space-y-4">
        <input 
          type="text" 
          id="username-input" 
          class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" 
          placeholder="Username" 
          required
        >
        <button 
          type="submit" 
          class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded transition duration-200"
        >
          Start Chatting
        </button>
      </form>
    </div>
  </div>

  <div class="chat-container">
    <!-- Main Chat Interface -->
    <div class="flex h-full bg-white">
      <!-- Sidebar Overlay (Mobile) -->
      <div id="sidebar-overlay" class="sidebar-overlay hidden" onclick="toggleSidebar()"></div>
      
      <!-- Sidebar -->
      <div id="sidebar" class="sidebar w-80 bg-white border-r border-gray-200 flex flex-col">
        <!-- Sidebar Header -->
        <div class="p-4 border-b border-gray-200 flex items-center justify-between">
          <div class="flex items-center space-x-2">
            <div class="h-10 w-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold">
              <span id="user-initial">U</span>
            </div>
            <div>
              <h3 id="current-username" class="font-bold">Username</h3>
              <p class="text-sm text-gray-500">Online</p>
            </div>
          </div>
          <button 
            id="clear-chat-btn" 
            class="text-gray-500 hover:text-gray-700 p-2" 
            aria-label="Clear chat history"
            title="Clear chat history"
          >
            <i class="fas fa-trash"></i>
          </button>
        </div>

        <!-- Search Bar -->
        <div class="p-4 border-b border-gray-200">
          <div class="relative">
            <input
              type="text"
              placeholder="Search contacts"
              id="contact-search"
              class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
          </div>
        </div>

        <!-- Contact List -->
        <div class="flex-1 overflow-y-auto">
          <div id="contacts-list" class="divide-y divide-gray-200">
            <!-- Contacts will be populated here -->
          </div>
        </div>
      </div>

      <!-- Main Chat Area -->
      <div class="flex-1 flex flex-col">
        <!-- Chat Header -->
        <div class="px-4 py-3 border-b border-gray-200 flex items-center">
          <button id="sidebar-toggle" class="mr-3 md:hidden text-gray-500 focus:outline-none" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
          </button>
          
          <div class="flex items-center">
            <div class="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center text-white mr-3">
              <span id="contact-initial">C</span>
            </div>
            <div>
              <h3 id="current-contact" class="font-bold">Select a contact</h3>
              <p id="contact-status" class="text-xs text-gray-500">Offline</p>
            </div>
          </div>
        </div>

        <!-- Chat Messages Area -->
        <div id="chat-messages" class="chat-messages flex-1 bg-gray-50">
          <div class="flex items-center justify-center h-full text-gray-500">
            <p>Select a contact to start chatting</p>
          </div>
        </div>

        <!-- Message Input Area -->
        <div id="message-input-container" class="p-3 border-t border-gray-200 bg-white">
          <!-- File Preview Area -->
          <div id="file-preview-container" class="hidden mb-2 p-2 bg-gray-100 rounded-lg">
            <div class="flex justify-between items-center">
              <div id="file-preview" class="flex items-center">
                <!-- File preview will be shown here -->
              </div>
              <button id="remove-file-btn" class="text-gray-500 hover:text-gray-700 p-1">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
          
          <div class="flex items-end space-x-2">
            <button id="attachment-btn" class="p-2 text-gray-500 hover:text-blue-500 focus:outline-none" aria-label="Add attachment">
              <i class="fas fa-paperclip"></i>
              <input type="file" id="file-input" class="hidden" accept="image/*,.pdf,.doc,.docx">
            </button>
            
            <div class="flex-1 relative">
              <textarea
                id="message-input"
                class="message-input w-full border border-gray-300 rounded-full pl-4 pr-12 py-2 focus:outline-none focus:border-blue-500"
                placeholder="Type a message..."
                rows="1"
                aria-label="Message input"
              ></textarea>
            </div>
            
            <button 
              id="send-btn" 
              class="p-3 bg-blue-500 text-white rounded-full hover:bg-blue-600 focus:outline-none" 
              aria-label="Send message"
              disabled
            >
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script id="app-script">
    // DOM Elements
    const usernameModal = document.getElementById('username-modal');
    const usernameForm = document.getElementById('username-form');
    const usernameInput = document.getElementById('username-input');
    const currentUsername = document.getElementById('current-username');
    const userInitial = document.getElementById('user-initial');
    const contactsList = document.getElementById('contacts-list');
    const contactSearch = document.getElementById('contact-search');
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const currentContact = document.getElementById('current-contact');
    const contactInitial = document.getElementById('contact-initial');
    const contactStatus = document.getElementById('contact-status');
    const clearChatBtn = document.getElementById('clear-chat-btn');
    const fileInput = document.getElementById('file-input');
    const attachmentBtn = document.getElementById('attachment-btn');
    const filePreviewContainer = document.getElementById('file-preview-container');
    const filePreview = document.getElementById('file-preview');
    const removeFileBtn = document.getElementById('remove-file-btn');
    const messageInputContainer = document.getElementById('message-input-container');

    // State variables
    let username = localStorage.getItem('quickchat-username') || '';
    let selectedContact = null;
    let selectedFile = null;
    let contacts = [];
    
    // Initialize the app
    function init() {
      // Check if username exists in localStorage
      if (username) {
        usernameModal.classList.add('hidden');
        currentUsername.textContent = username;
        userInitial.textContent = username.charAt(0).toUpperCase();
      }

      // Initialize chat messages from localStorage
      loadContacts();
      setupEventListeners();
      adjustTextareaHeight();
    }

    // Load contacts
    function loadContacts() {
      // Sample contacts
      contacts = [
        { id: 1, name: 'Alice Johnson', status: 'online', lastSeen: new Date(), avatar: null },
        { id: 2, name: 'Bob Smith', status: 'offline', lastSeen: new Date(Date.now() - 3600000), avatar: null },
        { id: 3, name: 'Charlie Davis', status: 'online', lastSeen: new Date(), avatar: null },
        { id: 4, name: 'Diana Wilson', status: 'away', lastSeen: new Date(Date.now() - 1800000), avatar: null },
        { id: 5, name: 'Edward Mitchell', status: 'online', lastSeen: new Date(), avatar: null },
        { id: 6, name: 'Fiona Taylor', status: 'offline', lastSeen: new Date(Date.now() - 86400000), avatar: null },
        { id: 7, name: 'George Brown', status: 'online', lastSeen: new Date(), avatar: null },
        { id: 8, name: 'Hannah Garcia', status: 'away', lastSeen: new Date(Date.now() - 7200000), avatar: null }
      ];

      renderContacts();
    }

    // Render contacts in the sidebar
    function renderContacts(searchTerm = '') {
      contactsList.innerHTML = '';
      
      const filteredContacts = searchTerm 
        ? contacts.filter(contact => 
            contact.name.toLowerCase().includes(searchTerm.toLowerCase()))
        : contacts;
      
      filteredContacts.forEach(contact => {
        const contactElement = document.createElement('div');
        contactElement.classList.add('contact-item', 'p-3', 'flex', 'items-center', 'hover:bg-gray-100');
        if (selectedContact && selectedContact.id === contact.id) {
          contactElement.classList.add('active');
        }
        
        contactElement.innerHTML = `
          <div class="h-12 w-12 rounded-full bg-gray-300 flex items-center justify-center text-white mr-3">
            <span>${contact.name.charAt(0).toUpperCase()}</span>
          </div>
          <div class="flex-1">
            <h4 class="font-medium">${contact.name}</h4>
            <p class="text-xs text-gray-500">
              ${contact.status === 'online' 
                ? '<span class="inline-block w-2 h-2 bg-green-500 rounded-full mr-1"></span> Online' 
                : contact.status === 'away'
                  ? '<span class="inline-block w-2 h-2 bg-yellow-500 rounded-full mr-1"></span> Away'
                  : '<span class="inline-block w-2 h-2 bg-gray-500 rounded-full mr-1"></span> Offline'}
            </p>
          </div>
        `;
        
        contactElement.addEventListener('click', () => selectContact(contact));
        contactsList.appendChild(contactElement);
      });
    }

    // Select a contact to chat with
    function selectContact(contact) {
      selectedContact = contact;
      currentContact.textContent = contact.name;
      contactInitial.textContent = contact.name.charAt(0).toUpperCase();
      contactStatus.innerHTML = contact.status === 'online' 
        ? '<span class="inline-block w-2 h-2 bg-green-500 rounded-full mr-1"></span> Online' 
        : contact.status === 'away'
          ? '<span class="inline-block w-2 h-2 bg-yellow-500 rounded-full mr-1"></span> Away'
          : '<span class="inline-block w-2 h-2 bg-gray-500 rounded-full mr-1"></span> Offline';
      
      renderContacts(contactSearch.value);
      loadChatHistory(contact.id);
      
      // On mobile, close sidebar after selecting contact
      if (window.innerWidth < 768) {
        toggleSidebar();
      }
    }

    // Load chat history for a specific contact
    function loadChatHistory(contactId) {
      chatMessages.innerHTML = '';
      
      const chatHistory = JSON.parse(localStorage.getItem(`chat-history-${contactId}`)) || [];
      
      if (chatHistory.length === 0) {
        chatMessages.innerHTML = `
          <div class="flex flex-col items-center justify-center h-full text-gray-500">
            <i class="fas fa-comments text-4xl mb-2"></i>
            <p>No messages yet</p>
            <p class="text-sm">Start the conversation with ${selectedContact.name}</p>
          </div>
        `;
        return;
      }
      
      chatHistory.forEach(message => {
        appendMessage(message, false);
      });
      
      scrollToBottom();
    }

    // Append a message to the chat
    function appendMessage(message, save = true) {
      const messageElement = document.createElement('div');
      const isSent = message.sender === username;
      
      messageElement.classList.add('message-container');
      
      let messageContent = `
        <div class="message-bubble ${isSent ? 'sent' : 'received'}">
          <div class="message-text">${message.text}</div>
      `;
      
      if (message.file) {
        if (message.file.type.startsWith('image/')) {
          messageContent += `
            <div class="mt-2">
              <img src="${message.file.data}" alt="Image attachment" class="image-attachment">
            </div>
          `;
        } else {
          messageContent += `
            <div class="file-attachment mt-2">
              <i class="fas fa-file mr-2"></i>
              <span>${message.file.name}</span>
            </div>
          `;
        }
      }
      
      messageContent += `
          <div class="timestamp">${formatTime(message.timestamp)}</div>
        </div>
      `;
      
      if (isSent) {
        messageContent += `
          <div class="read-receipt">
            <i class="fas fa-check-double ${message.read ? 'text-blue-500' : ''}"></i>
          </div>
        `;
      }
      
      messageElement.innerHTML = messageContent;
      
      if (chatMessages.querySelector('.flex.items-center.justify-center')) {
        chatMessages.innerHTML = '';
      }
      
      chatMessages.appendChild(messageElement);
      
      if (save && selectedContact) {
        saveChatMessage(message);
      }
      
      scrollToBottom();
    }

    // Save chat message to localStorage
    function saveChatMessage(message) {
      if (!selectedContact) return;
      
      const contactId = selectedContact.id;
      const chatHistory = JSON.parse(localStorage.getItem(`chat-history-${contactId}`)) || [];
      
      chatHistory.push(message);
      localStorage.setItem(`chat-history-${contactId}`, JSON.stringify(chatHistory));
    }

    // ADD: helper to call the FileHoster Loop
    async function uploadFileToHoster(file) {
      const loopUrl = 'https://magicloops.dev/api/loop/1f278d1d-9c22-4f97-8061-8042e8b738c5/run';
      const payload = {
        fileName: file.name,
        fileData: file.data.split(',')[1] // strip off "data:*/*;base64,"
      };
      const res = await fetch(loopUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      return await res.json(); // expect metadata, e.g. { url: 'https://...' }
    }

    // MODIFY sendMessage() to call the loop when there's a file
    async function sendMessage() {
      if (!selectedContact) {
        alert('Please select a contact first');
        return;
      }
      
      const text = messageInput.value.trim();
      if (!text && !selectedFile) return;
      
      let fileMeta = null;
      if (selectedFile) {
        // Show some UI feedback if you want...
        fileMeta = await uploadFileToHoster(selectedFile);
        // Override selectedFile.data to point at hosted URL
        selectedFile.data = fileMeta.url;
      }
      
      const message = {
        id: Date.now(),
        sender: username,
        receiver: selectedContact.id,
        text: text,
        timestamp: new Date(),
        read: false,
        file: selectedFile
      };
      
      appendMessage(message);
      messageInput.value = '';
      adjustTextareaHeight();
      sendBtn.disabled = true;
      
      // Reset file attachment
      selectedFile = null;
      filePreviewContainer.classList.add('hidden');
      filePreview.innerHTML = '';
      fileInput.value = '';
      
      // Simulate received messages after a delay
      simulateReceivedMessage();
    }

    // Simulate a received message for demonstration
    function simulateReceivedMessage() {
      if (!selectedContact) return;
      
      // Show typing indicator
      const typingIndicator = document.createElement('div');
      typingIndicator.classList.add('typing-indicator');
      typingIndicator.innerHTML = `
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      `;
      chatMessages.appendChild(typingIndicator);
      scrollToBottom();
      
      // After a delay, remove typing indicator and add a reply
      setTimeout(() => {
        typingIndicator.remove();
        
        const responses = [
          "Hi there! How can I help you today?",
          "That's interesting. Tell me more.",
          "I understand what you mean.",
          "That's a good point!",
          "Let me think about that for a moment.",
          "I'm not sure I follow. Could you explain?",
          "I appreciate your message!",
          "Great to hear from you!",
          "Thanks for sharing that with me.",
          "I'll get back to you on that soon."
        ];
        
        const randomResponse = responses[Math.floor(Math.random() * responses.length)];
        
        const message = {
          id: Date.now(),
          sender: selectedContact.name,
          receiver: username,
          text: randomResponse,
          timestamp: new Date(),
          read: true
        };
        
        appendMessage(message);
        
        // Mark the last sent message as read
        const chatHistory = JSON.parse(localStorage.getItem(`chat-history-${selectedContact.id}`)) || [];
        const lastSentMessage = [...chatHistory].reverse().find(msg => msg.sender === username);
        
        if (lastSentMessage) {
          lastSentMessage.read = true;
          localStorage.setItem(`chat-history-${selectedContact.id}`, JSON.stringify(chatHistory));
          
          // Update read receipt in UI
          const readReceipts = document.querySelectorAll('.read-receipt .fa-check-double');
          if (readReceipts.length > 0) {
            readReceipts[readReceipts.length - 1].classList.add('text-blue-500');
          }
        }
      }, 1500);
    }

    // Handle file selection
    function handleFileSelection(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      // Check file size (25MB max)
      if (file.size > 25 * 1024 * 1024) {
        alert('File size exceeds the 25MB limit');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(event) {
        selectedFile = {
          name: file.name,
          type: file.type,
          size: file.size,
          data: event.target.result
        };
        
        filePreviewContainer.classList.remove('hidden');
        filePreview.innerHTML = '';
        
        if (file.type.startsWith('image/')) {
          const img = document.createElement('img');
          img.src = event.target.result;
          img.classList.add('file-preview');
          filePreview.appendChild(img);
        } else {
          filePreview.innerHTML = `
            <div class="flex items-center">
              <i class="fas fa-file text-blue-500 mr-2"></i>
              <span class="truncate max-w-xs">${file.name}</span>
              <span class="ml-2 text-xs text-gray-500">${formatFileSize(file.size)}</span>
            </div>
          `;
        }
        
        sendBtn.disabled = false;
      };
      reader.readAsDataURL(file);
    }

    // Remove selected file
    function removeSelectedFile() {
      selectedFile = null;
      filePreviewContainer.classList.add('hidden');
      filePreview.innerHTML = '';
      fileInput.value = '';
      sendBtn.disabled = !messageInput.value.trim();
    }

    // Format time for display in chat
    function formatTime(date) {
      date = new Date(date);
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // Format file size
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
      else return (bytes / 1048576).toFixed(1) + ' MB';
    }

    // Toggle sidebar visibility (mobile)
    function toggleSidebar() {
      sidebar.classList.toggle('open');
      sidebarOverlay.classList.toggle('hidden');
    }

    // Clear chat history
    function clearChat() {
      if (!selectedContact) return;
      
      if (confirm('Are you sure you want to clear this chat history? This action cannot be undone.')) {
        localStorage.removeItem(`chat-history-${selectedContact.id}`);
        loadChatHistory(selectedContact.id);
      }
    }

    // Auto-resize textarea
    function adjustTextareaHeight() {
      messageInput.style.height = 'auto';
      messageInput.style.height = (messageInput.scrollHeight) + 'px';
    }

    // Scroll to the bottom of the chat
    function scrollToBottom() {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Event listeners
    function setupEventListeners() {
      // Username form submission
      usernameForm.addEventListener('submit', (e) => {
        e.preventDefault();
        username = usernameInput.value.trim();
        if (username) {
          localStorage.setItem('quickchat-username', username);
          currentUsername.textContent = username;
          userInitial.textContent = username.charAt(0).toUpperCase();
          usernameModal.classList.add('hidden');
        }
      });

      // Message input events
      messageInput.addEventListener('input', () => {
        adjustTextareaHeight();
        sendBtn.disabled = messageInput.value.trim() === '' && !selectedFile;
      });
      
      messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          if (!sendBtn.disabled) {
            sendMessage();
          }
        }
      });

      // Send button click
      sendBtn.addEventListener('click', sendMessage);

      // Contact search
      contactSearch.addEventListener('input', () => {
        renderContacts(contactSearch.value);
      });

      // Clear chat button
      clearChatBtn.addEventListener('click', clearChat);

      // File input
      fileInput.addEventListener('change', handleFileSelection);
      
      attachmentBtn.addEventListener('click', () => {
        fileInput.click();
      });
      
      removeFileBtn.addEventListener('click', removeSelectedFile);
    }

    // Initialize app
    init();
  </script>
</body>
</html>